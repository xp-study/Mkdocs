# 环境搭建

## 参考文档

1. [Helm2官方安装文档：Installing Helm](https://v2.helm.sh/docs/using_helm/#quickstart)
2. [Helm Hub仓库地址](https://hub.helm.sh/)
3. [部署和体验Helm(2.16.1版本)](https://cloud.tencent.com/developer/article/1560271)
4. [Helm chart仓库官方仓库不能使用解决方法](https://www.cnblogs.com/heaven-xi/p/11207528.html)

## 安装环境

* 主机操作系统：Ubuntu16.04.2 64位
* Docker版本：18.06.2-ce-3-0~ubuntu
* Kubernetes版本：1.15.3
* Helm版本：2.16.2
* 搭建日期：2020.3.21

在本文档初次搭建时Helm2和Helm3两个大版本，其中Helm3将服务端Tiller移除了，考虑到兼容性问题我们还是采用Helm2的稳定版本。可以在[Github Release](https://github.com/helm/helm/releases)页面找到所有的发布版本，并且可以下载相应的二进制文件。

Helm2中包含两个组件，分别是Helm客户端和Tiller服务器，功能分别如下：

* Helm客户端：是一个命令行工具，用于本地开发及管理chart及其仓库等
* Tiller服务器：Tiller负责接收Helm的请求，与Kubernetes的ApiServer交互，根据`chart`定义生成和管理各种Kubernetes资源对象

接下来我们将依次安装这两个组件

!!! note "非常重要"
    **本文档只针对Helm2版本，其中的步骤不适用于Helm3**

## Helm客户端安装

[点击这里](https://get.helm.sh/helm-v2.16.2-linux-amd64.tar.gz)下载2.16.2版本的Helm客户端二进制文件，如果你想下载其他版本可以访问[Github Release](https://github.com/helm/helm/releases)。

下载完成之后安装如下步骤解压，拷贝到系统目录：

```bash
# 解压压缩包
tar -zxvf helm-v2.16.2-linux-amd64.tar.gz

# 拷贝到系统目录
cp linux-amd64/helm linux-amd64/tiller /usr/local/bin/

# 查看Helm版本
helm version
Client: &version.Version{SemVer:"v2.16.2", GitCommit:"bbdfe5e7803a12bbdf97e94cd847859890cf4050", GitTreeState:"clean"}
Error: could not find tiller
# 因为没有安装tillerServer所以暂时会报找不到tiller
```

## 创建角色绑定

为了保证Helm能够安全地和生产集群进行交互(服务上线、升级、回滚等操作)，在安装Tiller之前需要创建一个基于Kubernetes RBAC机制的用户角色。关于Helm2更详细的权限控制可以参考[官方文档](https://v2.helm.sh/docs/using_helm/#role-based-access-control)

创建ServiceAccount：`tiller`

```bash
kubectl create serviceaccount --namespace kube-system tiller
```

创建ClusterRole：`tiller-cluster-rule`并和`tiller`用户绑定

```bash
kubectl create clusterrolebinding tiller-cluster-rule --clusterrole=cluster-admin --serviceaccount=kube-system:tiller
```

## Tiller服务器安装

在安装Tiller服务器之前准备好一个Kubernetes集群，**需要在一台能够访问到Kubernetes集群的主机上面执行下面的命令**

可以执行如下命令确认和Tiller关联的集群信息：

```bash
root@tt-iot-test-master:~# kubectl cluster-info
Kubernetes master is running at https://172.31.10.251:6443
KubeDNS is running at https://172.31.10.251:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
```

确认集群正确之后使用`helm init`命令安装Tiller服务器

!!! note "注意事项"
    因为helm默认使用的`https://kubernetes-charts.storage.googleapis.com`仓库国内无法正常访问，需要切换可以访问的仓库，下面列举几个常用的地址：

    * `https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts` (阿里云，使用过程中发现有些chart没有同步所以 **不推荐使用**)
    * `http://mirror.azure.cn/kubernetes/charts` (微软云stable仓库，基本上官网有的chart这里都有所以 **推荐使用**)
    * `http://mirror.azure.cn/kubernetes/charts-incubator` (微软云incubator仓库，需要时使用)

```bash
# 使用Helm命令来安装Tiller服务器
helm init --upgrade -i registry.cn-hangzhou.aliyuncs.com/google_containers/tiller:v2.16.2 \
          --stable-repo-url  http://mirror.azure.cn/kubernetes/charts \
          --service-account tiller

# 正常情况下将会输出如下内容
Creating /root/.helm
Creating /root/.helm/repository
Creating /root/.helm/repository/cache
Creating /root/.helm/repository/local
Creating /root/.helm/plugins
Creating /root/.helm/starters
Creating /root/.helm/cache/archive
Creating /root/.helm/repository/repositories.yaml
Adding stable repo with URL: https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts
Adding local repo with URL: http://127.0.0.1:8879/charts
$HELM_HOME has been configured at /root/.helm.

Tiller (the Helm server-side component) has been installed into your Kubernetes Cluster.

Please note: by default, Tiller is deployed with an insecure 'allow unauthenticated users' policy.
To prevent this, run `helm init` with the --tiller-tls-verify flag.
For more information on securing your installation see: https://docs.helm.sh/using_helm/#securing-your-helm-installation
```

通过如下命令验证安装是否成功：

```bash
# 查看Helm版本，可以看到客户端和服务器的版本都可以可见
root@tt-iot-test-master:~# helm version
Client: &version.Version{SemVer:"v2.16.2", GitCommit:"bbdfe5e7803a12bbdf97e94cd847859890cf4050", GitTreeState:"clean"}
Server: &version.Version{SemVer:"v2.16.2", GitCommit:"bbdfe5e7803a12bbdf97e94cd847859890cf4050", GitTreeState:"clean"}

# 查看Tiller容器是否正常运行
root@tt-iot-test-master:~# kubectl get pod -n kube-system | grep tiller
tiller-deploy-6c5d6b55d9-lzhrm               1/1     Running   0          8m40s

# 查看Tiller服务的运行信息
root@tt-iot-test-master:~# kubectl get svc -n kube-system | grep tiller
tiller-deploy          ClusterIP   10.101.175.242   <none>        44134/TCP                10m

# 使用Helm命令查询已部署应用，正常情况打印是空的，如果出现错误打印就需要专门解决
helm list
```

### 更换仓库源

可以使用如下命令查看仓库源：

```bash
helm repo list
local   http://127.0.0.1:8879/charts
stable  http://mirror.azure.cn/kubernetes/charts
```

当我们需要更换源时可以使用如下命令：

```bash
# 先删除现有仓库源
helm repo remove stable

helm repo add stable http://mirror.azure.cn/kubernetes/charts
helm repo list
```
